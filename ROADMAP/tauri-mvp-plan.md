# Vibe Kanban Tauri MVP 迁移计划

> **文档版本**: 1.0
> **创建日期**: 2025-01-15
> **目标平台**: macOS
> **架构策略**: Sidecar 架构

## MVP 目标

**目标**: 创建一个功能完整的最小可行产品，验证 Sidecar 架构的可行性

**成功标准**:
- ✅ Tauri 应用可以独立启动（无需浏览器）
- ✅ Sidecar 服务器自动启动和管理
- ✅ 核心功能正常工作
- ✅ 可以打包为 macOS .app

---

## 架构概览

```
┌─────────────────────────────────────────────────────────────────┐
│                    Vibe Kanban Tauri App                        │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │              Tauri 应用层 (主进程)                       │   │
│  │                                                         │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │   │
│  │  │  窗口管理   │  │  菜单栏     │  │  系统托盘   │     │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘     │   │
│  │                                                         │   │
│  │  ┌─────────────────────────────────────────────────┐   │   │
│  │  │         React Frontend (WebView)                │   │   │
│  │  │                                                 │   │   │
│  │  │  • 所有现有 UI 组件                             │   │   │
│  │  │  • API 调用 → http://localhost:SIDEACR_PORT   │   │   │
│  │  └─────────────────────────────────────────────────┘   │   │
│  │                              │                         │   │
│  └──────────────────────────────┼─────────────────────────┘   │
│                                 │ HTTP                         │
│  ┌──────────────────────────────▼─────────────────────────┐   │
│  │           Tauri Shell Plugin (进程管理)                │   │
│  └──────────────────────────────┬─────────────────────────┘   │
│                                 │ 启动/监控                     │
│  ┌──────────────────────────────▼─────────────────────────┐   │
│  │         Sidecar 进程 (vibe-kanban-server)             │   │
│  │                                                         │   │
│  │  • 现有 Axum 服务器 (几乎无需修改)                      │   │
│  │  • SQLite 数据库                                       │   │
│  │  • Git 操作                                            │   │
│  │  • 编码代理管理                                        │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 迁移任务清单

### 🔵 必需任务 (MVP 核心)

| # | 任务 | 说明 | 工作量 | 优先级 |
|---|------|------|--------|--------|
| **后端 - 基础设施** |
| 1.1 | 创建 Tauri 项目结构 | 在 frontend/ 下初始化 Tauri | 2小时 | P0 |
| 1.2 | 配置 tauri.conf.json | macOS 应用元数据、权限配置 | 2小时 | P0 |
| 1.3 | 配置 Sidecar 二进制 | 设置 externalBin 路径 | 2小时 | P0 |
| 1.4 | Server 代码适配 | 添加动态端口分配和状态文件输出 | 4小时 | P0 |
| 1.5 | Server 启动命令 | Tauri Command 启动 Sidecar | 4小时 | P0 |
| 1.6 | 进程健康检查 | 监控 Sidecar 状态，自动重启 | 4小时 | P0 |
| 1.7 | 数据库路径迁移 | 适配 Tauri AppData 目录 | 3小时 | P0 |
| **前端 - 适配** |
| 1.8 | API 基础 URL 配置 | 开发/生产环境切换 | 2小时 | P0 |
| 1.9 | 服务器状态检测 | WebSocket 连接重试逻辑 | 3小时 | P0 |
| 1.10 | 加载状态 UI | 启动时显示加载画面 | 2小时 | P0 |
| **应用壳功能** |
| 1.11 | 应用图标 | macOS .app 图标设计 | 2小时 | P0 |
| 1.12 | 窗口配置 | 默认窗口大小、行为 | 1小时 | P0 |
| 1.13 | 应用菜单 | macOS 标准菜单配置 | 2小时 | P0 |
| **构建与打包** |
| 1.14 | 开发构建 | pnpm tauri dev 正常运行 | 2小时 | P0 |
| 1.15 | 生产构建 | pnpm tauri build 生成 .app | 3小时 | P0 |
| 1.16 | 基础测试 | 核心功能冒烟测试 | 4小时 | P0 |

**P0 小计**: 约 42 小时 (约 1 周)

---

### 🟢 增强任务 (提升体验)

| # | 任务 | 说明 | 工作量 | 优先级 |
|---|------|------|--------|--------|
| **原生功能集成** |
| 2.1 | 系统托盘 | 菜单栏图标、快速操作 | 4小时 | P1 |
| 2.2 | 全局快捷键 | 全局快捷键触发操作 | 3小时 | P2 |
| 2.3 | 原生通知 | macOS 通知集成 | 2小时 | P2 |
| 2.4 | 顶部菜单栏集成 | macOS 菜单栏功能 | 3小时 | P2 |
| **用户体验** |
| 2.5 | 首次运行引导 | 新用户欢迎界面 | 4小时 | P1 |
| 2.6 | 数据迁移工具 | 从 B/S 版本导入数据 | 6小时 | P1 |
| 2.7 | 设置界面 | 应用设置（主题、行为等） | 4小时 | P2 |
| **应用生命周期** |
| 2.8 | 关闭确认 | 防止意外关闭 | 1小时 | P2 |
| 2.9 | 最小化到托盘 | 窗口行为选项 | 2小时 | P2 |
| 2.10 | 自动启动 | 登录时自动启动 | 2小时 | P2 |
| **窗口管理** |
| 2.11 | 窗口状态保存 | 记住窗口位置和大小 | 3小时 | P2 |
| 2.12 | 多窗口支持 | 可选的多窗口功能 | 6小时 | P3 |

**P1-P2 小计**: 约 40 小时

---

### 🟡 优化任务 (长期改进)

| # | 任务 | 说明 | 工作量 | 优先级 |
|---|------|------|--------|--------|
| **性能优化** |
| 3.1 | 启动时间优化 | 减少冷启动时间 | 8小时 | P2 |
| 3.2 | 内存优化 | 降低内存占用 | 8小时 | P3 |
| 3.3 | Sidecar 通信优化 | 优化 HTTP 连接池 | 4小时 | P3 |
| **分发与更新** |
| 3.4 | 自动更新 | Tauri 更新器集成 | 6小时 | P1 |
| 3.5 | 代码签名配置 | macOS 开发者签名 | 4小时 | P1 |
| 3.6 | 公证配置 | macOS 公证 (公证要求) | 4小时 | P1 |
| 3.7 | DMG 安装包制作 | 安装包设计和配置 | 4小时 | P2 |
| 3.8 | Sparkle 更新框架 | 可选的更新框架 | 6小时 | P3 |
| **监控与日志** |
| 3.9 | Sentry 集成 | 前端错误监控 | 3小时 | P2 |
| 3.10 | 崩溃报告 | 后端崩溃处理 | 4小时 | P3 |
| 3.11 | 日志查看器 | 应用内日志查看 | 4小时 | P3 |
| **高级功能** |
| 3.12 | Touch Bar 支持 | MacBook Pro Touch Bar | 6小时 | P3 |
| 3.13 | 深色模式自适应 | 跟随系统主题 | 2小时 | P2 |
| 3.14 | 离线模式检测 | 网络状态处理 | 3小时 | P3 |

**P2-P3 小计**: 约 66 小时

---

### 🔴 可选任务 (探索性功能)

| # | 任务 | 说明 | 工作量 | 优先级 |
|---|------|------|--------|--------|
| **跨平台准备** |
| 4.1 | Windows 适配 | Windows 平台支持 | 16小时 | P3 |
| 4.2 | Linux 适配 | Linux 平台支持 | 12小时 | P3 |
| **高级集成** |
| 4.3 | iCloud 同步 | iCloud 数据同步 | 12小时 | P3 |
| 4.4 | Spotlight 集成 | macOS Spotlight 搜索 | 8小时 | P3 |
| 4.5 | Share Extension | macOS 分享扩展 | 8小时 | P3 |
| **开发工具** |
| 4.6 | 开发者工具集成 | 内置 DevTools | 2小时 | P3 |
| 4.7 | 调试模式 | 详细调试信息 | 3小时 | P3 |
| **实验性功能** |
| 4.8 | IPC 混合模式 | 部分功能迁移到 IPC | 16小时 | P3 |
| 4.9 | 插件系统 | 插件架构设计 | 20小时 | P3 |

**P3 小计**: 约 97 小时

---

## 推荐的 MVP 范围

### 方案 A: 最小 MVP (1-2 周)

**目标**: 快速验证架构可行性

**包含任务**:
- ✅ 所有 🔵 P0 必需任务 (42 小时)
- ✅ 2.1 系统托盘 (4 小时)
- ✅ 2.5 首次运行引导 (4 小时)
- ✅ 3.4 自动更新 (6 小时)
- ✅ 3.5 代码签名配置 (4 小时)

**总计**: 约 60 小时 (1.5 周)

**交付物**:
- 可运行的 Tauri 应用
- 基础的 macOS 应用体验
- 自动更新能力

---

### 方案 B: 标准 MVP (3-4 周) ⭐ 推荐

**目标**: 完整的用户体验

**包含任务**:
- ✅ 所有 🔵 P0 必需任务 (42 小时)
- ✅ 所有 🟢 P1 增强任务 (约 20 小时)
- ✅ 3.4 自动更新 (6 小时)
- ✅ 3.5 代码签名配置 (4 小时)
- ✅ 3.6 公证配置 (4 小时)
- ✅ 3.7 DMG 安装包 (4 小时)

**总计**: 约 80 小时 (2 周)

**交付物**:
- 完整功能的 Tauri 应用
- 系统托盘和原生体验
- 可分发的安装包
- 自动更新机制

---

### 方案 C: 完整版 MVP (5-6 周)

**目标**: 生产就绪的应用

**包含任务**:
- ✅ 所有 🔵 P0 必需任务 (42 小时)
- ✅ 所有 🟢 P1-P2 增强任务 (约 40 小时)
- ✅ 所有 🟡 P1-P2 优化任务 (约 30 小时)

**总计**: 约 112 小时 (2.8 周)

**交付物**:
- 功能完整的生产级应用
- 完善的用户体验
- 完整的分发和更新流程

---

## 技术实施细节

### 1. Tauri 项目结构

```
frontend/
├── src/                          # 现有 React 代码
│   ├── components/
│   ├── pages/
│   ├── lib/
│   │   └── api.ts               # 修改: API 基础 URL
│   └── ...
├── src-tauri/                    # 新增: Tauri 项目
│   ├── Cargo.toml
│   ├── tauri.conf.json
│   ├── capabilities/
│   │   └── default.json
│   ├── src/
│   │   ├── lib.rs
│   │   ├── commands.rs          # Tauri Commands
│   │   └── sidecar.rs           # Sidecar 管理逻辑
│   ├── icons/
│   └── build.rs
├── package.json
├── vite.config.ts
└── tsconfig.json
```

### 2. 关键文件配置

#### tauri.conf.json
```json
{
  "productName": "Vibe Kanban",
  "version": "0.0.153",
  "identifier": "com.vibekanban.app",
  "build": {
    "beforeDevCommand": "pnpm dev:prepare",
    "beforeBuildCommand": "pnpm build",
    "frontendDist": "../dist",
    "frontendDevServerUrl": "http://localhost:5173"
  },
  "app": {
    "macOSPrivateApi": false,
    "security": {
      "csp": null
    },
    "windows": [
      {
        "title": "Vibe Kanban",
        "width": 1200,
        "height": 800,
        "minWidth": 800,
        "minHeight": 600
      }
    ]
  },
  "bundle": {
    "active": true,
    "targets": ["dmg"],
    "icon": ["icons/icon.icns", "icons/icon.png"],
    "externalBin": [
      "../target/release/vibe-kanban-server"
    ]
  },
  "plugins": {
    "shell": {
      "scope": [
        {
          "name": "run-server",
          "cmd": "../target/release/vibe-kanban-server",
          "args": []
        }
      ]
    }
  }
}
```

#### API 基础 URL 配置
```typescript
// frontend/src/lib/api.ts
const getApiBaseUrl = () => {
  // 开发环境: 使用现有的后端开发服务器
  if (import.meta.env.MODE === 'development') {
    return import.meta.env.VITE_API_URL || 'http://127.0.0.1:8080';
  }

  // Tauri 生产环境: Sidecar 端口
  // 1. 从环境变量读取 (由 Sidecar 设置)
  // 2. 回退到默认端口
  return window.__API_BASE_URL__ || 'http://127.0.0.1:58532';
};

export const api = {
  // 所有现有 API 方法保持不变
  getProjects: () => fetch(`${getApiBaseUrl()}/api/projects`),
  // ...
};
```

### 3. Sidecar 管理逻辑

```rust
// src-tauri/src/sidecar.rs
use tauri::{AppHandle, Emitter, Manager};
use std::process::Command;

#[tauri::command]
async fn start_sidecar(app: AppHandle) -> Result<String, String> {
    // 1. 获取 Sidecar 二进制路径
    let sidecar_path = app.path()
        .resolve("vibe-kanban-server", tauri::path::BaseDirectory::Resource)
        .map_err(|e| e.to_string())?;

    // 2. 启动 Sidecar 进程
    let child = Command::new(&sidecar_path)
        .spawn()
        .map_err(|e| format!("Failed to start sidecar: {}", e))?;

    // 3. 等待服务器启动并获取端口
    let port = wait_for_server_ready().await?;

    // 4. 通知前端服务器就绪
    app.emit("server-ready", port).map_err(|e| e.to_string())?;

    Ok(format!("Sidecar started on port {}", port))
}

async fn wait_for_server_ready() -> Result<u16, String> {
    // 实现等待逻辑: 读取状态文件或轮询健康检查
    // ...
    Ok(58532)
}
```

---

## 决策清单

请根据您的需求选择要包含的任务：

### MVP 必需 (P0)
- [ ] 1.1 - 1.3: Tauri 项目基础设置
- [ ] 1.4 - 1.7: Server 适配和进程管理
- [ ] 1.8 - 1.10: 前端适配
- [ ] 1.11 - 1.13: 应用壳基础功能
- [ ] 1.14 - 1.16: 构建与测试

### 增强功能 (P1)
- [ ] 2.1: 系统托盘
- [ ] 2.5: 首次运行引导
- [ ] 2.6: 数据迁移工具
- [ ] 3.4: 自动更新
- [ ] 3.5: 代码签名配置
- [ ] 3.6: 公证配置
- [ ] 3.7: DMG 安装包

### 可选增强 (P2)
- [ ] 2.2: 全局快捷键
- [ ] 2.3: 原生通知
- [ ] 2.4: 顶部菜单栏集成
- [ ] 2.7: 设置界面
- [ ] 2.8: 关闭确认
- [ ] 2.9: 最小化到托盘
- [ ] 2.10: 自动启动
- [ ] 2.11: 窗口状态保存
- [ ] 3.1: 启动时间优化
- [ ] 3.13: 深色模式自适应

### 高级/可选 (P3)
- [ ] 2.12: 多窗口支持
- [ ] 3.2: 内存优化
- [ ] 3.8: Sparkle 更新框架
- [ ] 3.9: Sentry 集成
- [ ] 3.10: 崩溃报告
- [ ] 3.11: 日志查看器
- [ ] 3.12: Touch Bar 支持
- [ ] 4.1 - 4.9: 其他可选功能

---

## 下一步行动

1. **审阅本计划**，确认 MVP 范围
2. **标记需要的任务**，我可以据此制定详细实施方案
3. **确认优先级**，确定实施顺序
4. **开始开发**，我将协助具体实施

---

**说明**: 本计划基于 Sidecar 架构设计，保留了现有代码库的稳定性，同时提供原生桌面应用体验。任务优先级和范围可以根据实际需求调整。
